diff --git a/ayanavita-fontend/src/api/lessons.api.ts b/ayanavita-fontend/src/api/lessons.api.ts
index 7b0a838e2e424c9f817dcfb513e8fe4eb5a3681b..9e3a504f1be78b444bb7c3c03b296e96b7d5924b 100644
--- a/ayanavita-fontend/src/api/lessons.api.ts
+++ b/ayanavita-fontend/src/api/lessons.api.ts
@@ -1,31 +1,47 @@
-// src/api/lessons.api.ts
 import { get, post } from "./http";

+export type LessonVideoItem = {
+  id: number;
+  title: string;
+  localizedTitle?: string;
+  playbackUrl?: string;
+  durationSec?: number;
+  progress?: { watchedSec: number; durationSec: number; completed: boolean };
+};
+
+export type LessonModuleItem = {
+  id: number;
+  title: string;
+  localizedTitle?: string;
+  videos: LessonVideoItem[];
+  progress?: { watchedSec: number; durationSec: number; percent: number; completed: boolean };
+};
+
 export type LessonDetail = {
   id: number;
   courseId: number;
   title: string;
+  localizedTitle?: string;
   slug?: string | null;
   order?: number | null;
   published?: boolean;
   content?: string | null;
+  modules?: LessonModuleItem[];
   createdAt?: string;
   updatedAt?: string;
 };

 export const lessonsApi = {
-  // GET /lessons/:id (GATED)
-  detail(id: number) {
-    return get<LessonDetail>(`/lessons/${id}`, { auth: true });
+  detail(id: number, lang?: string) {
+    const q = lang ? `?lang=${encodeURIComponent(lang)}` : "";
+    return get<LessonDetail>(`/lessons/${id}${q}`, { auth: true });
   },

-  // POST /lessons/:id/progress (touch IN_PROGRESS)
   touchProgress(id: number) {
     return post<{ ok: boolean }>(`/lessons/${id}/progress`, {}, { auth: true });
   },

-  // POST /lessons/:id/complete
   complete(id: number) {
     return post<{ ok: boolean }>(`/lessons/${id}/complete`, {}, { auth: true });
   },
 };
diff --git a/ayanavita-fontend/src/api/progress.api.ts b/ayanavita-fontend/src/api/progress.api.ts
index ab3343112d94e53fc499b81f628fa430ae2cb4fa..14e55faaeb5ce205be4f44f0ef3c05394e9a2f15 100644
--- a/ayanavita-fontend/src/api/progress.api.ts
+++ b/ayanavita-fontend/src/api/progress.api.ts
@@ -1,154 +1,56 @@
 // src/api/progress.api.ts
 import { get, post } from "./http";

-/**
- * Nên thống nhất status có NOT_STARTED để UI dùng luôn
- * - Backend thực tế thường chỉ lưu record khi có hoạt động,
- *   nên lesson chưa học => progress = null => NOT_STARTED.
- */
 export type ProgressStatus = "NOT_STARTED" | "IN_PROGRESS" | "COMPLETED";

-/**
- * FE-friendly view of lesson progress
- * - seconds: map từ lastPositionSec (backend)
- */
 export type LessonProgress = {
   lessonId: number;
   status: ProgressStatus;
   seconds?: number | null;
   updatedAt?: string;
 };

-/**
- * Course progress response (FE-friendly)
- * - items: danh sách progress theo lessonId
- */
 export type CourseProgressRes = {
   courseId: number;
   totalLessons: number;
   completedLessons: number;
-  percent: number; // 0..100
-  items?: LessonProgress[];
+  percent: number;
+  items: LessonProgress[];
 };

-/**
- * Backend raw types (để không mismatch khi backend trả progress object lồng)
- */
-export type ProgressRecord = {
-  lessonId: number;
-  status: Exclude<ProgressStatus, "NOT_STARTED">; // record đã tồn tại thì thường IN_PROGRESS/COMPLETED
-  percent?: number | null;
-  lastPositionSec?: number | null;
-  lastOpenedAt?: string | null;
-  completedAt?: string | null;
-  updatedAt?: string | null;
-};
-
-export type BackendCourseProgressItem = {
-  lessonId: number;
-  title: string;
-  order?: number | null;
-  published?: boolean;
-  progress: ProgressRecord | null;
-};
-
-export type BackendCourseProgressRes = {
-  courseId: number;
-  totalLessons: number;
-  completedLessons: number;
-  percent: number; // 0..100
-  items: BackendCourseProgressItem[];
-};
-
-/**
- * Backend Progress DTO:
- * POST /lessons/:id/progress
- * body: { lastPositionSec?: number; percent?: number }
- */
 export type UpsertProgressBody = {
   lastPositionSec?: number;
   percent?: number;
 };

-function toLessonProgressList(raw: BackendCourseProgressRes): LessonProgress[] {
-  const items = raw?.items || [];
-  return items.map((it) => {
-    // Nếu progress null => NOT_STARTED
-    if (!it.progress) {
-      return {
-        lessonId: it.lessonId,
-        status: "NOT_STARTED",
-        seconds: null,
-        updatedAt: undefined,
-      };
-    }
-
-    return {
-      lessonId: it.lessonId,
-      status: (it.progress.status ?? "IN_PROGRESS") as ProgressStatus,
-      seconds: it.progress.lastPositionSec ?? null,
-      updatedAt: it.progress.updatedAt ?? undefined,
-    };
-  });
-}
-
 export const progressApi = {
-  /**
-   * Upsert progress (idempotent)
-   * POST /lessons/:id/progress
-   */
   upsert: (lessonId: number, body: UpsertProgressBody) =>
-    post<{ ok: boolean }>(`/lessons/${lessonId}/progress`, body, { auth: true }),
+    post(`/lessons/${lessonId}/progress`, body, { auth: true }),

-  /**
-   * Backward-compatible helper:
-   * - seconds (FE) -> lastPositionSec (BE)
-   */
   markProgress: (lessonId: number, seconds?: number, percent?: number) =>
-    post<{ ok: boolean }>(
+    post(
       `/lessons/${lessonId}/progress`,
       {
         ...(seconds !== undefined ? { lastPositionSec: seconds } : {}),
         ...(percent !== undefined ? { percent } : {}),
       } as UpsertProgressBody,
       { auth: true }
     ),

-  /**
-   * Shortcut complete
-   * POST /lessons/:id/complete
-   */
-  complete: (lessonId: number) =>
-    post<{ ok: boolean }>(`/lessons/${lessonId}/complete`, {}, { auth: true }),
+  complete: (lessonId: number) => post(`/lessons/${lessonId}/complete`, {}, { auth: true }),

-  /**
-   * GET /me/progress
-   * Backend trả array lessonProgress (kèm lesson) => để any cho linh hoạt
-   */
-  myProgress: () => get<any>(`/me/progress`, { auth: true }),
+  updateVideoProgress: (lessonId: number, videoId: number, watchedSec: number, completed = false) =>
+    post(
+      `/lessons/${lessonId}/videos/${videoId}/progress`,
+      { watchedSec, completed },
+      { auth: true }
+    ),

-  /**
-   * GET /me/courses/:courseId/progress
-   * Trả về FE-friendly CourseProgressRes (items = LessonProgress[])
-   * bằng cách map từ backend raw response.
-   */
-  courseProgress: async (courseId: number): Promise<CourseProgressRes> => {
-    const raw = await get<BackendCourseProgressRes>(`/me/courses/${courseId}/progress`, {
-      auth: true,
-    });
+  completeModule: (lessonId: number, moduleId: number) =>
+    post(`/lessons/${lessonId}/modules/${moduleId}/complete`, {}, { auth: true }),

-    return {
-      courseId: raw.courseId,
-      totalLessons: raw.totalLessons,
-      completedLessons: raw.completedLessons,
-      percent: raw.percent,
-      items: toLessonProgressList(raw),
-    };
-  },
+  myProgress: () => get<any>(`/me/progress`, { auth: true }),

-  /**
-   * Nếu UI nào đó cần raw (title/order/published + progress lồng)
-   */
-  courseProgressRaw: (courseId: number) =>
-    get<BackendCourseProgressRes>(`/me/courses/${courseId}/progress`, { auth: true }),
+  courseProgress: (courseId: number) =>
+    get<CourseProgressRes>(`/me/courses/${courseId}/progress`, { auth: true }),
 };
diff --git a/ayanavita-fontend/src/pages/LessonDetailPage.tsx b/ayanavita-fontend/src/pages/LessonDetailPage.tsx
index faabc4c79fa0dced4d290f577287bfce1340affe..ae854cd0c769153f6c25f46d9891589727a1f1ec 100644
--- a/ayanavita-fontend/src/pages/LessonDetailPage.tsx
+++ b/ayanavita-fontend/src/pages/LessonDetailPage.tsx
@@ -1,670 +1,196 @@
-// src/pages/LessonDetailPage.tsx
 import React, { useEffect, useMemo, useState } from "react";
 import { Link, useNavigate, useParams, useSearchParams } from "react-router-dom";
-
 import { coursesApi, type Lesson } from "../api/courses.api";
+import { lessonsApi, type LessonDetail, type LessonVideoItem } from "../api/lessons.api";
 import { progressApi, type CourseProgressRes } from "../api/progress.api";
-import { lessonsApi, type LessonDetail } from "../api/lessons.api";
-
-import { LessonsSidebar } from "../components/LessonsSidebar";
-import { EnrollmentGatePanel } from "../components/EnrollmentGatePanel";
-import { useEnrollmentGate } from "../hooks/useEnrollmentGate";
-
-import {
-  buildSequentialRows,
-  getLessonNavFromRows,
-  statusOf,
-  type LessonStatusUI,
-} from "../shared/lessons";
-
-import {
-  AppShell,
-  Badge,
-  Button,
-  Card,
-  Container,
-  Hr,
-  Muted,
-  SubTitle,
-  Title,
-  Tooltip,
-  theme,
-} from "../ui/ui";
-
-import {
-  IconArrowLeft,
-  IconCheck,
-  IconInfo,
-  IconLock,
-  IconPlay,
-  IconRefresh,
-} from "../ui/icons";
-
-type LessonView = Lesson & {
-  order?: number | null;
-  published?: boolean;
+import { useAuth } from "../state/auth.store";
+
+const t = {
+  vi: {
+    myLearning: "Trang học viên",
+    user: "Học viên",
+    course: "Khóa học",
+    progress: "Tiến độ",
+    lessonList: "Danh sách bài học",
+    completeModule: "Hoàn thành module",
+    watched: "Đã xem hết",
+  },
+  en: {
+    myLearning: "Student Learning",
+    user: "User",
+    course: "Course",
+    progress: "Progress",
+    lessonList: "Lesson list",
+    completeModule: "Complete module",
+    watched: "Watched",
+  },
+  de: {
+    myLearning: "Lernseite",
+    user: "Benutzer",
+    course: "Kurs",
+    progress: "Fortschritt",
+    lessonList: "Lektionen",
+    completeModule: "Modul abschließen",
+    watched: "Angesehen",
+  },
+} as const;
+
+type Lang = keyof typeof t;
+
+type OutlineLesson = Lesson & {
+  localizedTitle?: string;
+  progress?: { status?: string; percent?: number } | null;
 };

-function sortLessons(ls: LessonView[]) {
-  return [...ls].sort((a, b) => {
-    const ao = a.order ?? 0;
-    const bo = b.order ?? 0;
-    if (ao !== bo) return ao - bo;
-    return a.id - b.id;
-  });
-}
-
-function useMediaQuery(query: string) {
-  const [match, setMatch] = useState(() => {
-    if (typeof window === "undefined") return false;
-    return window.matchMedia(query).matches;
-  });
-
-  useEffect(() => {
-    const m = window.matchMedia(query);
-    const onChange = () => setMatch(m.matches);
-    onChange();
-    m.addEventListener?.("change", onChange);
-    return () => m.removeEventListener?.("change", onChange);
-  }, [query]);
-
-  return match;
-}
-
-function StatusBadge({ status }: { status: LessonStatusUI }) {
-  if (status === "COMPLETED") {
-    return (
-      <Badge tone="success">
-        <IconCheck /> COMPLETED
-      </Badge>
-    );
-  }
-  if (status === "IN_PROGRESS") return <Badge tone="warning">IN_PROGRESS</Badge>;
-  return <Badge tone="neutral">NOT_STARTED</Badge>;
-}
-
-type ViewMode = "LOADING" | "ENROLLMENT_BLOCKED" | "SEQUENTIAL_LOCKED" | "CONTENT";
-
-function DebugRibbon(props: {
-  enabled: boolean;
-  courseId: number;
-  lessonId: number;
-  viewMode: string;
-  gateStatus: string;
-  gateLoading: boolean;
-  canAccess: boolean;
-  unlocked: boolean;
-  prevId: number;
-  nextId: number;
-}) {
-  if (!props.enabled) return null;
-
-  return (
-    <div
-      style={{
-        position: "sticky",
-        top: 0,
-        zIndex: 50,
-        marginBottom: 12,
-        padding: "10px 12px",
-        borderRadius: 14,
-        border: `1px solid ${theme.colors.border}`,
-        background: "rgba(255,255,255,0.92)",
-        backdropFilter: "blur(8px)",
-        display: "flex",
-        gap: 10,
-        flexWrap: "wrap",
-        alignItems: "center",
-      }}
-    >
-      <Badge tone="info">DEBUG</Badge>
-
-      <span style={{ fontSize: 12, color: theme.colors.muted }}>
-        viewMode=<b style={{ color: theme.colors.text }}>{props.viewMode}</b>
-      </span>
-
-      <span style={{ fontSize: 12, color: theme.colors.muted }}>
-        gate.status=<b style={{ color: theme.colors.text }}>{props.gateStatus}</b>
-      </span>
-
-      <span style={{ fontSize: 12, color: theme.colors.muted }}>
-        gate.loading=<b style={{ color: theme.colors.text }}>{String(props.gateLoading)}</b>
-      </span>
-
-      <span style={{ fontSize: 12, color: theme.colors.muted }}>
-        gate.canAccess=<b style={{ color: theme.colors.text }}>{String(props.canAccess)}</b>
-      </span>
-
-      <span style={{ fontSize: 12, color: theme.colors.muted }}>
-        unlocked=<b style={{ color: theme.colors.text }}>{String(props.unlocked)}</b>
-      </span>
-
-      <span style={{ fontSize: 12, color: theme.colors.muted }}>
-        courseId=<b style={{ color: theme.colors.text }}>{props.courseId}</b>
-      </span>
-
-      <span style={{ fontSize: 12, color: theme.colors.muted }}>
-        lessonId=<b style={{ color: theme.colors.text }}>{props.lessonId}</b>
-      </span>
-
-      <span style={{ fontSize: 12, color: theme.colors.muted }}>
-        prev=<b style={{ color: theme.colors.text }}>{props.prevId || "-"}</b>
-      </span>
-
-      <span style={{ fontSize: 12, color: theme.colors.muted }}>
-        next=<b style={{ color: theme.colors.text }}>{props.nextId || "-"}</b>
-      </span>
-    </div>
-  );
-}
-
-
 export function LessonDetailPage() {
-  const nav = useNavigate();
   const { id } = useParams();
-  const lessonId = Number(id);
-
+  const lessonId = Number(id || 0);
   const [sp] = useSearchParams();
   const courseId = Number(sp.get("courseId") || 0);
+  const nav = useNavigate();
+  const { user } = useAuth();

-  // Enrollment gate: Order -> Pending -> Active
-  const gate = useEnrollmentGate(courseId, { adminBypass: false, auto: true });
-
-  const [lesson, setLesson] = useState<LessonDetail | null>(null);
-  const [courseLessons, setCourseLessons] = useState<LessonView[]>([]);
-  const [progress, setProgress] = useState<CourseProgressRes | null>(null);
-
+  const [lang, setLang] = useState<Lang>("vi");
   const [loading, setLoading] = useState(true);
-  const [busy, setBusy] = useState(false);
   const [err, setErr] = useState<string | null>(null);
-  const [info, setInfo] = useState<string | null>(null);
-
-  // Derived
-  const isWide = useMediaQuery("(min-width: 980px)");
-  const hasCourseId = Number.isFinite(courseId) && courseId > 0;
-
-  /**
-   * Seq rows used for sidebar + prev/next + status.
-   * Note: when progress = null, buildSequentialRows should still produce a stable structure.
-   */
-  const seqRows = useMemo(() => buildSequentialRows(courseLessons as any, progress as any), [
-    courseLessons,
-    progress,
-  ]);

-  const lessonNav = useMemo(() => getLessonNavFromRows(seqRows, lessonId), [seqRows, lessonId]);
-
-  const currentStatus: LessonStatusUI = useMemo(() => statusOf(seqRows, lessonId), [seqRows, lessonId]);
-
-  const enrollmentBlocked = useMemo(() => {
-    if (!hasCourseId) return false;
-    if (gate.loading) return true; // treat as blocked until known
-    return gate.status !== "ACTIVE";
-  }, [hasCourseId, gate.loading, gate.status]);
-
-  const sequentialLocked = useMemo(() => {
-    // Sequential lock only meaningful when enrollment is active and we have rows
-    if (!hasCourseId) return false;
-    if (gate.loading) return false;
-    if (gate.status !== "ACTIVE") return false;
-    return !lessonNav.unlocked;
-  }, [hasCourseId, gate.loading, gate.status, lessonNav.unlocked]);
-
-  const viewMode: ViewMode = useMemo(() => {
-    if (loading) return "LOADING";
-    if (enrollmentBlocked) return "ENROLLMENT_BLOCKED";
-    if (sequentialLocked) return "SEQUENTIAL_LOCKED";
-    return "CONTENT";
-  }, [loading, enrollmentBlocked, sequentialLocked]);
+  const [courseTitle, setCourseTitle] = useState("");
+  const [outline, setOutline] = useState<OutlineLesson[]>([]);
+  const [progress, setProgress] = useState<CourseProgressRes | null>(null);
+  const [lesson, setLesson] = useState<LessonDetail | null>(null);

-  async function loadAll() {
-    if (!Number.isFinite(lessonId) || lessonId <= 0) return;
+  const tx = t[lang];
+
+  const doneLessons = useMemo(() => {
+    const set = new Set<number>();
+    outline.forEach((l) => {
+      if (l.progress?.status === "COMPLETED" || (l.progress?.percent || 0) >= 100) set.add(l.id);
+    });
+    if (progress?.items) {
+      progress.items.forEach((x) => {
+        if (x.status === "COMPLETED") set.add(x.lessonId);
+      });
+    }
+    return set;
+  }, [outline, progress]);

+  async function loadAll(targetLessonId = lessonId) {
+    if (!courseId || !targetLessonId) return;
     setLoading(true);
     setErr(null);
-    setInfo(null);
-
-    // --------
-    // 1) Load lessons list + progress depending on enrollment gate
-    // --------
-    let lessonsList: LessonView[] = [];
-    let prog: CourseProgressRes | null = null;
-
-    if (hasCourseId) {
-      // If enrollment not ACTIVE (or still loading), do NOT fetch gated lessons/progress.
-      // Use outline instead to render sidebar.
-      if (!gate.loading && gate.status === "ACTIVE") {
-        const [lsRes, pRes] = await Promise.allSettled([
-          coursesApi.lessons(courseId),
-          progressApi.courseProgress(courseId),
-        ]);
-
-        if (lsRes.status === "fulfilled") lessonsList = sortLessons(lsRes.value as LessonView[]);
-        else {
-          lessonsList = [];
-          setErr((lsRes as any)?.reason?.message || "Không tải được lessons.");
-        }
-
-        if (pRes.status === "fulfilled") prog = pRes.value;
-        else prog = null;
-      } else {
-        // Not ACTIVE (PENDING/NOT_ENROLLED/CANCELLED/UNKNOWN or loading): outline only
-        try {
-          const outline = await coursesApi.lessonsOutline(courseId);
-          lessonsList = sortLessons(outline as LessonView[]);
-        } catch {
-          lessonsList = [];
-        }
-        prog = null;
-      }
-    }
-
-    setCourseLessons(lessonsList);
-    setProgress(prog);
-
-    // --------
-    // 2) Decide whether to fetch lesson detail
-    //    “Đúng chuẩn”: chỉ fetch detail khi:
-    //      - Enrollment ACTIVE (nếu có courseId)
-    //      - Và lesson unlocked theo sequential (nếu có courseId)
-    // --------
-    let shouldFetchDetail = true;
-
-    if (hasCourseId) {
-      // Enrollment not ACTIVE OR still loading => do not fetch detail
-      if (gate.loading || gate.status !== "ACTIVE") shouldFetchDetail = false;
-      else {
-        // Compute unlocked from freshly fetched lessons/progress (avoid relying on stale state)
-        const rowsNow = buildSequentialRows(lessonsList as any, prog as any);
-        const navNow = getLessonNavFromRows(rowsNow, lessonId);
-        if (!navNow.unlocked) shouldFetchDetail = false;
-      }
-    }
-
-    if (!shouldFetchDetail) {
-      setLesson(null);
-      setLoading(false);
-      return;
-    }
-
-    // --------
-    // 3) Fetch detail (gated endpoint)
-    // --------
     try {
-      const d = await lessonsApi.detail(lessonId);
-      setLesson(d);
-
-      // touch progress (IN_PROGRESS) – best effort
-      lessonsApi.touchProgress(lessonId).catch(() => {});
+      const [course, lessonData, outlineData, progressData] = await Promise.all([
+        coursesApi.detail(courseId),
+        lessonsApi.detail(targetLessonId, lang),
+        coursesApi.lessonsOutline(courseId) as Promise<OutlineLesson[]>,
+        progressApi.courseProgress(courseId),
+      ]);
+      setCourseTitle(course?.title || "");
+      setLesson(lessonData);
+      setOutline(outlineData || []);
+      setProgress(progressData || null);
     } catch (e: any) {
-      setLesson(null);
-      // 403 or other errors: show message; UI will show gating blocks if courseId present
-      setErr(e?.message || "Bạn không có quyền xem nội dung bài học.");
+      setErr(e?.message || "Không tải được dữ liệu bài học");
     } finally {
       setLoading(false);
     }
   }

   useEffect(() => {
-    let alive = true;
-    (async () => {
-      if (!alive) return;
-      await loadAll();
-    })();
-    return () => {
-      alive = false;
-    };
+    void loadAll();
     // eslint-disable-next-line react-hooks/exhaustive-deps
-  }, [lessonId, courseId, gate.loading, gate.status]);
-
-  async function onComplete() {
-    setBusy(true);
-    setErr(null);
-    setInfo(null);
-
-    try {
-      await lessonsApi.complete(lessonId);
-      setInfo("Đã hoàn thành bài. Đang cập nhật tiến độ…");
-
-      // Refresh progress & compute next unlocked
-      let nextId = 0;
-
-      if (hasCourseId && !gate.loading && gate.status === "ACTIVE") {
-        try {
-          const p = await progressApi.courseProgress(courseId);
-          setProgress(p);
+  }, [lessonId, courseId, lang]);

-          const rowsNew = buildSequentialRows(courseLessons as any, p as any);
-          nextId = getLessonNavFromRows(rowsNew, lessonId).nextId;
-        } catch {
-          // ignore
-        }
-      }
+  async function handleVideoDone(video: LessonVideoItem) {
+    if (!lesson) return;
+    await progressApi.updateVideoProgress(lesson.id, video.id, video.durationSec || 0, true);
+    await loadAll(lesson.id);
+  }

-      if (nextId) nav(`/lessons/${nextId}?courseId=${courseId}`);
-    } catch (e: any) {
-      setErr(e?.message || "Complete failed");
-    } finally {
-      setBusy(false);
-    }
+  async function handleModuleDone(moduleId: number) {
+    if (!lesson) return;
+    await progressApi.completeModule(lesson.id, moduleId);
+    await loadAll(lesson.id);
   }

   return (
-    <AppShell>
-      <Container>
-        {/* Top bar */}
-        <div
-          style={{
-            display: "flex",
-            justifyContent: "space-between",
-            gap: 12,
-            flexWrap: "wrap",
-            alignItems: "center",
-            marginBottom: 12,
-          }}
-        >
-          <div style={{ display: "flex", gap: 10, flexWrap: "wrap", alignItems: "center" }}>
-            <Link
-              to={hasCourseId ? `/courses/${courseId}` : "/courses"}
-              style={{
-                color: theme.colors.text,
-                textDecoration: "none",
-                display: "inline-flex",
-                gap: 8,
-                alignItems: "center",
-              }}
-            >
-              <IconArrowLeft /> Quay lại
-            </Link>
-
-            {hasCourseId ? (
-              <Link to={`/courses/${courseId}`} style={{ color: theme.colors.text, textDecoration: "none" }}>
-                Course Detail
-              </Link>
-            ) : null}
-          </div>
-
-          <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
-            <Button
-              tone="neutral"
-              variant="ghost"
-              onClick={() => void loadAll()}
-              disabled={loading || busy}
-              leftIcon={<IconRefresh />}
-            >
-              Reload
-            </Button>
-          </div>
+    <div style={{ maxWidth: 1200, margin: "20px auto", padding: 16 }}>
+      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
+        <h2>{tx.myLearning}</h2>
+        <div style={{ display: "flex", gap: 10 }}>
+          <Link to="/me/courses">/me/courses</Link>
+          <select value={lang} onChange={(e) => setLang(e.target.value as Lang)}>
+            <option value="vi">VI</option>
+            <option value="en">EN</option>
+            <option value="de">DE</option>
+          </select>
         </div>
-
-        {/* Debug ribbon (DEV only) */}
-<DebugRibbon
-  enabled={import.meta.env.DEV || sp.get("debug") === "1"}
-  courseId={courseId}
-  lessonId={lessonId}
-  viewMode={viewMode}
-  gateStatus={gate.status}
-  gateLoading={gate.loading}
-  canAccess={gate.canAccess}
-  unlocked={lessonNav.unlocked}
-  prevId={lessonNav.prevId}
-  nextId={lessonNav.nextId}
-/>
-
-
-        {/* Alerts */}
-        {loading ? (
-          <Card style={{ marginBottom: 12 }}>
-            <Title>Đang tải…</Title>
-            <SubTitle>Đang lấy lessons/progress và kiểm tra quyền truy cập.</SubTitle>
-          </Card>
-        ) : null}
-
-        {err ? (
-          <Card style={{ marginBottom: 12 }}>
-            <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
-              <Badge tone="danger">
-                <IconInfo /> ERROR
-              </Badge>
-              <div style={{ fontWeight: 800 }}>{err}</div>
-            </div>
-          </Card>
-        ) : null}
-
-        {info ? (
-          <Card style={{ marginBottom: 12 }}>
-            <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
-              <Badge tone="info">
-                <IconInfo /> INFO
-              </Badge>
-              <div style={{ fontWeight: 800 }}>{info}</div>
-            </div>
-          </Card>
-        ) : null}
-
-        {/* Header */}
-        <Card style={{ marginBottom: 12 }}>
-          <div
-            style={{
-              display: "flex",
-              justifyContent: "space-between",
-              gap: 12,
-              flexWrap: "wrap",
-              alignItems: "flex-start",
-            }}
-          >
-            <div style={{ minWidth: 280, flex: "1 1 520px" }}>
-              <Title>{lesson?.title || `Lesson #${lessonId}`}</Title>
-              <SubTitle>
-                Trạng thái: <StatusBadge status={currentStatus} />
-                {hasCourseId ? (
-                  <span style={{ marginLeft: 10, color: theme.colors.faint, fontSize: 12 }}>
-                    courseId={courseId}
-                  </span>
-                ) : null}
-              </SubTitle>
-            </div>
-
-            <div
-              style={{
-                minWidth: 280,
-                flex: "0 1 360px",
-                display: "flex",
-                gap: 10,
-                justifyContent: "flex-end",
-                flexWrap: "wrap",
-              }}
-            >
-              <Button
-                tone="success"
-                onClick={() => void onComplete()}
-                disabled={
-                  busy ||
-                  loading ||
-                  viewMode !== "CONTENT" ||
-                  !lessonNav.unlocked ||
-                  (hasCourseId ? gate.status !== "ACTIVE" : false)
-                }
-                leftIcon={<IconCheck />}
-              >
-                Hoàn thành
-              </Button>
-
-              <Tooltip content="Bài học bị khoá theo sequential rule" disabled={lessonNav.unlocked}>
-                <span>
-                  <Button
-                    tone="primary"
-                    variant="ghost"
-                    disabled={busy || !lessonNav.nextId}
-                    leftIcon={<IconPlay />}
-                    onClick={() => {
-                      if (!lessonNav.nextId) return;
-                      nav(`/lessons/${lessonNav.nextId}?courseId=${courseId}`);
-                    }}
-                  >
-                    Next
-                  </Button>
-                </span>
-              </Tooltip>
-            </div>
-          </div>
-
-          <Hr />
-
-          {!lessonNav.unlocked && hasCourseId && !gate.loading && gate.status === "ACTIVE" ? (
-            <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
-              <Badge tone="warning">
-                <IconLock /> LOCKED
-              </Badge>
-              <Muted>Hoàn thành bài trước để mở khoá bài này.</Muted>
-            </div>
-          ) : null}
-        </Card>
-
-        {/* 2-column layout */}
-        <div
-          style={{
-            display: "grid",
-            gridTemplateColumns: isWide ? "320px 1fr" : "1fr",
-            gap: 12,
-            alignItems: "start",
-          }}
-        >
-          {/* Sidebar */}
-          <LessonsSidebar
-            lessons={courseLessons as any}
-            progress={progress as any}
-            rows={seqRows}
-            currentLessonId={lessonId}
-            courseId={courseId}
-            sticky={isWide}
-            title="Lessons"
-            primaryLabel="Mở"
-            onPrimary={(id2) => nav(`/lessons/${id2}?courseId=${courseId}`)}
-          />
-
-          {/* Main */}
-          <div style={{ display: "grid", gap: 12 }}>
-            {/* Enrollment gate */}
-            {viewMode === "ENROLLMENT_BLOCKED" ? (
-              <div style={{ display: "grid", gap: 12 }}>
-                <EnrollmentGatePanel
-                  courseId={courseId}
-                  adminBypass={false}
-                  title="Nội dung đang bị khoá"
-                  pollMs={5000}
-                  showOrdersLink={true}
-                  onBecameActive={() => {
-                    // vừa ACTIVE => reload full lessons/progress/content
-                    void loadAll();
-                  }}
-                />
-
-                <Card>
-                  <Title>Không thể xem nội dung</Title>
-                  <SubTitle>
-                    Nội dung yêu cầu Enrollment <b>ACTIVE</b>. Nếu bạn vừa tạo order, trạng thái sẽ về{" "}
-                    <b>PENDING</b> và tự mở khi admin mark-paid.
-                  </SubTitle>
-                </Card>
+      </div>
+
+      <div style={{ marginBottom: 12, opacity: 0.9 }}>
+        <div>{tx.user}: <b>{user?.name || user?.email || "-"}</b></div>
+        <div>{tx.course}: <b>{courseTitle || "-"}</b></div>
+      </div>
+
+      <div style={{ height: 10, borderRadius: 999, background: "#ececec", overflow: "hidden" }}>
+        <div style={{ height: "100%", background: "#111", width: `${progress?.percent || 0}%` }} />
+      </div>
+      <div style={{ margin: "6px 0 12px" }}>{tx.progress}: <b>{progress?.percent || 0}%</b></div>
+
+      {loading && <div>Loading...</div>}
+      {err && <div style={{ color: "crimson" }}>{err}</div>}
+
+      <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr", gap: 14 }}>
+        <div style={{ border: "1px solid #ddd", borderRadius: 12, padding: 12 }}>
+          <h3>{lesson?.localizedTitle || lesson?.title || `Lesson #${lessonId}`}</h3>
+          {!lesson?.modules?.length && <div style={{ opacity: 0.7 }}>Lesson chưa có module/video.</div>}
+
+          {lesson?.modules?.map((m) => (
+            <div key={m.id} style={{ marginTop: 10, border: "1px solid #eee", borderRadius: 10, padding: 10 }}>
+              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", gap: 10 }}>
+                <div>
+                  <b>{m.localizedTitle || m.title}</b>
+                  <div style={{ fontSize: 12, opacity: 0.8 }}>{m.progress?.percent || 0}%</div>
+                </div>
+                <button onClick={() => void handleModuleDone(m.id)}>{tx.completeModule}</button>
               </div>
-            ) : null}
-
-            {/* Sequential locked (Enrollment ACTIVE but not unlocked) */}
-            {viewMode === "SEQUENTIAL_LOCKED" ? (
-              <Card>
-                <Title>Bài học đang bị khoá (Sequential)</Title>
-                <SubTitle>
-                  Bạn cần hoàn thành bài trước để mở bài này. Đây là khóa theo lộ trình.
-                </SubTitle>
-                <Hr />
-                <div style={{ display: "flex", gap: 10, flexWrap: "wrap", alignItems: "center" }}>
-                  <Badge tone="warning">
-                    <IconLock /> LOCKED
-                  </Badge>

-                  <Button
-                    tone="neutral"
-                    variant="ghost"
-                    disabled={!lessonNav.prevId}
-                    onClick={() => {
-                      if (!lessonNav.prevId) return;
-                      nav(`/lessons/${lessonNav.prevId}?courseId=${courseId}`);
-                    }}
-                  >
-                    Về bài trước
-                  </Button>
-
-                  <Button tone="neutral" variant="ghost" onClick={() => void loadAll()} leftIcon={<IconRefresh />}>
-                    Kiểm tra lại
-                  </Button>
+              {m.videos?.map((v) => (
+                <div key={v.id} style={{ display: "grid", gridTemplateColumns: "1fr auto", gap: 10, marginTop: 8, alignItems: "center" }}>
+                  <div>
+                    <div>{v.localizedTitle || v.title}</div>
+                    {!!v.playbackUrl && (
+                      <video
+                        controls
+                        src={v.playbackUrl}
+                        style={{ width: "100%", marginTop: 6, borderRadius: 8 }}
+                        onEnded={() => void handleVideoDone(v)}
+                      />
+                    )}
+                  </div>
+                  <button onClick={() => void handleVideoDone(v)}>
+                    {tx.watched} {v.progress?.completed ? "✓" : ""}
+                  </button>
                 </div>
-              </Card>
-            ) : null}
-
-            {/* Content */}
-            {viewMode === "CONTENT" ? (
-              <Card>
-                <Title>Nội dung bài học</Title>
-                <SubTitle>Chỉ hiển thị khi Enrollment ACTIVE và lesson unlocked.</SubTitle>
-                <Hr />
-
-                {lesson?.content ? (
-                  <div
-                    style={{ lineHeight: 1.7, color: theme.colors.text }}
-                    dangerouslySetInnerHTML={{ __html: lesson.content }}
-                  />
-                ) : (
-                  <Muted>Chưa có content hoặc backend không trả content.</Muted>
-                )}
-              </Card>
-            ) : null}
-
-            {/* When loading but already rendered list */}
-            {viewMode === "LOADING" ? (
-              <Card>
-                <Title>Đang kiểm tra quyền truy cập…</Title>
-                <SubTitle>Vui lòng chờ.</SubTitle>
-              </Card>
-            ) : null}
-
-            {/* Quick nav */}
-            {hasCourseId ? (
-              <Card>
-                <Title>Điều hướng nhanh</Title>
-                <SubTitle>Prev/Next dựa theo lessons trong course + sequential rule.</SubTitle>
-                <Hr />
-
-                <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
-                  <Button
-                    tone="neutral"
-                    variant="ghost"
-                    disabled={!lessonNav.prevId}
-                    onClick={() => {
-                      if (!lessonNav.prevId) return;
-                      nav(`/lessons/${lessonNav.prevId}?courseId=${courseId}`);
-                    }}
-                  >
-                    Prev
-                  </Button>
+              ))}
+            </div>
+          ))}
+        </div>

-                  <Button
-                    tone="primary"
-                    variant="ghost"
-                    disabled={!lessonNav.nextId}
-                    onClick={() => {
-                      if (!lessonNav.nextId) return;
-                      nav(`/lessons/${lessonNav.nextId}?courseId=${courseId}`);
-                    }}
-                  >
-                    Next (Unlocked)
-                  </Button>
-                </div>
-              </Card>
-            ) : null}
-          </div>
+        <div style={{ border: "1px solid #ddd", borderRadius: 12, padding: 12 }}>
+          <h3>{tx.lessonList}</h3>
+          {outline.map((l) => (
+            <button
+              key={l.id}
+              style={{ width: "100%", textAlign: "left", marginBottom: 8, border: "1px solid #eee", borderRadius: 8, padding: 8, background: l.id === lessonId ? "#f6f3ff" : "#fff" }}
+              onClick={() => nav(`/lessons/${l.id}?courseId=${courseId}`)}
+            >
+              <span style={{ marginRight: 6 }}>▾</span>
+              <span>{doneLessons.has(l.id) ? "✅" : "⬜"} {l.localizedTitle || l.title}</span>
+            </button>
+          ))}
         </div>
-      </Container>
-    </AppShell>
+      </div>
+    </div>
   );
 }
diff --git a/ayanavita-fontend/src/pages/MyCoursesPage.tsx b/ayanavita-fontend/src/pages/MyCoursesPage.tsx
index d8288e5de3f51ead16900b662399ccf5f0b8ec5f..cf02b2874a44053a2a7cf3616ecf8ccc6487a35e 100644
--- a/ayanavita-fontend/src/pages/MyCoursesPage.tsx
+++ b/ayanavita-fontend/src/pages/MyCoursesPage.tsx
@@ -155,51 +155,51 @@ export function MyCoursesPage() {
       if (st !== "COMPLETED") return l.id;
     }

     // 3) tất cả completed -> vào bài cuối
     return sorted[sorted.length - 1].id;
   }

   async function onContinue(courseId: number) {
     setErr(null);
     setInfo(null);

     try {
       // Backend sẽ 403 nếu Enrollment chưa ACTIVE
       const lessons = await coursesApi.lessons(courseId);
       if (!lessons || lessons.length === 0) {
         setInfo("Khoá học chưa có bài học nào.");
         return;
       }

       const lessonId = pickContinueLessonId(courseId, lessons);
       if (!lessonId) {
         setInfo("Không xác định được bài học để tiếp tục.");
         return;
       }

-      nav(`/lessons/${lessonId}`);
+      nav(`/lessons/${lessonId}?courseId=${courseId}`);
     } catch (e: any) {
       setErr(
         e?.message ||
           "Không thể tiếp tục học (có thể Enrollment chưa ACTIVE nên bị chặn 403)."
       );
     }
   }

   return (
     <div style={{ maxWidth: 1000, margin: "24px auto", padding: 16 }}>
       <div
         style={{
           display: "flex",
           justifyContent: "space-between",
           alignItems: "center",
         }}
       >
         <h2>Khoá học của tôi</h2>
         <div style={{ display: "flex", gap: 12, alignItems: "center" }}>
           <Link to="/courses">Khoá học</Link>
           <Link to="/me/orders">My Orders</Link>
           <button onClick={load}>Reload</button>
         </div>
       </div>

diff --git a/backend/ayanavitabackend/app/api/prisma/migrations/202603200001_lesson_video_progress/migration.sql b/backend/ayanavitabackend/app/api/prisma/migrations/202603200001_lesson_video_progress/migration.sql
new file mode 100644
index 0000000000000000000000000000000000000000..965a1e30a0f254903ad61a3e59837929a9150045
--- /dev/null
+++ b/backend/ayanavitabackend/app/api/prisma/migrations/202603200001_lesson_video_progress/migration.sql
@@ -0,0 +1,26 @@
+CREATE TABLE `LessonVideoProgress` (
+  `id` INT NOT NULL AUTO_INCREMENT,
+  `userId` INT NOT NULL,
+  `lessonId` INT NOT NULL,
+  `moduleId` INT NOT NULL,
+  `videoId` INT NOT NULL,
+  `watchedSec` INT NOT NULL DEFAULT 0,
+  `completed` BOOLEAN NOT NULL DEFAULT false,
+  `completedAt` DATETIME(3) NULL,
+  `createdAt` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
+  `updatedAt` DATETIME(3) NOT NULL,
+  UNIQUE INDEX `LessonVideoProgress_userId_videoId_key`(`userId`, `videoId`),
+  INDEX `LessonVideoProgress_userId_lessonId_idx`(`userId`, `lessonId`),
+  INDEX `LessonVideoProgress_userId_moduleId_idx`(`userId`, `moduleId`),
+  PRIMARY KEY (`id`)
+) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
+
+ALTER TABLE `LessonVideoProgress`
+  ADD CONSTRAINT `LessonVideoProgress_userId_fkey`
+  FOREIGN KEY (`userId`) REFERENCES `User`(`id`) ON DELETE CASCADE ON UPDATE CASCADE,
+  ADD CONSTRAINT `LessonVideoProgress_lessonId_fkey`
+  FOREIGN KEY (`lessonId`) REFERENCES `Lesson`(`id`) ON DELETE CASCADE ON UPDATE CASCADE,
+  ADD CONSTRAINT `LessonVideoProgress_moduleId_fkey`
+  FOREIGN KEY (`moduleId`) REFERENCES `LessonModule`(`id`) ON DELETE CASCADE ON UPDATE CASCADE,
+  ADD CONSTRAINT `LessonVideoProgress_videoId_fkey`
+  FOREIGN KEY (`videoId`) REFERENCES `LessonVideo`(`id`) ON DELETE CASCADE ON UPDATE CASCADE;
diff --git a/backend/ayanavitabackend/app/api/prisma/migrations/202603200002_course_access/migration.sql b/backend/ayanavitabackend/app/api/prisma/migrations/202603200002_course_access/migration.sql
new file mode 100644
index 0000000000000000000000000000000000000000..6198bb040da397577fcfd7446691bb8f783f067b
--- /dev/null
+++ b/backend/ayanavitabackend/app/api/prisma/migrations/202603200002_course_access/migration.sql
@@ -0,0 +1,18 @@
+CREATE TABLE `CourseAccess` (
+  `id` INT NOT NULL AUTO_INCREMENT,
+  `userId` INT NOT NULL,
+  `courseId` INT NOT NULL,
+  `status` ENUM('ACTIVE', 'CANCELED') NOT NULL DEFAULT 'ACTIVE',
+  `grantedAt` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
+  `createdAt` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
+  `updatedAt` DATETIME(3) NOT NULL,
+  UNIQUE INDEX `CourseAccess_userId_courseId_key`(`userId`, `courseId`),
+  INDEX `CourseAccess_courseId_idx`(`courseId`),
+  PRIMARY KEY (`id`)
+) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
+
+ALTER TABLE `CourseAccess`
+  ADD CONSTRAINT `CourseAccess_userId_fkey`
+  FOREIGN KEY (`userId`) REFERENCES `User`(`id`) ON DELETE CASCADE ON UPDATE CASCADE,
+  ADD CONSTRAINT `CourseAccess_courseId_fkey`
+  FOREIGN KEY (`courseId`) REFERENCES `Course`(`id`) ON DELETE CASCADE ON UPDATE CASCADE;
diff --git a/backend/ayanavitabackend/app/api/prisma/schema.prisma b/backend/ayanavitabackend/app/api/prisma/schema.prisma
index 23984047330c6186d0e9af4e8ba05aa560d6e73f..2cbbc59ef7caa50c88b4c60151879a49d132c060 100644
--- a/backend/ayanavitabackend/app/api/prisma/schema.prisma
+++ b/backend/ayanavitabackend/app/api/prisma/schema.prisma
@@ -1,50 +1,52 @@
 generator client {
   provider = "prisma-client-js"
 }

 datasource db {
   provider          = "mysql"
   url               = env("DATABASE_URL")
   shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
 }

 model User {
   id                 Int      @id @default(autoincrement())
   email              String   @unique
   password           String
   name               String?
   phone              String?
   role               Role     @default(USER)
   isActive           Boolean  @default(true)
   hashedRefreshToken String?  @db.Text
   createdAt          DateTime @default(now())
   updatedAt          DateTime @updatedAt

   // ✅ ADD
   enrollments    Enrollment[]
+  courseAccesses CourseAccess[]
   lessonProgress LessonProgress[]
+  lessonVideoProgress LessonVideoProgress[]
   orders         Order[] // <— opposite for Order.user

   // ✅ CMS (optional relations)
   cmsSectionVersions CmsSectionVersion[]
   mediaAssets        MediaAsset[]
   serviceReviews     ServiceReview[]
   specialistProfile  Specialist?
 }

 model Branch {
   id          Int                @id @default(autoincrement())
   code        String             @unique @db.VarChar(32)
   name        String             @db.VarChar(255)
   address     String             @db.VarChar(255)
   phone       String?            @db.VarChar(30)
   isActive    Boolean            @default(true)
   createdAt   DateTime           @default(now())
   updatedAt   DateTime           @updatedAt
   services    BranchService[]
   specialists Specialist[]
   appointments Appointment[]
   translations BranchTranslation[]
 }

 model ServiceCategory {
@@ -241,50 +243,51 @@ model RegistrationOtp {
   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt
 }

 model Course {
   id                  Int      @id @default(autoincrement())
   topicId             Int?
   title               String
   shortDescription    String?  @db.VarChar(500)
   slug                String   @unique
   description         String?
   thumbnail           String?
   price               Int      @default(0)
   published           Boolean  @default(false)
   objectives          Json?
   targetAudience      Json?
   benefits            Json?
   ratingAvg           Float    @default(0)
   ratingCount         Int      @default(0)
   enrollmentCount     Int      @default(0)
   createdAt           DateTime @default(now())
   updatedAt           DateTime @updatedAt

   lessons     Lesson[]
   enrollments Enrollment[]
+  accesses    CourseAccess[]
   topic       CourseTopic? @relation(fields: [topicId], references: [id], onDelete: Restrict)
   translations CourseTranslation[]
   contentTranslations CourseContentTranslation[]

   // ✅ ADD
   orderItems OrderItem[] // <— opposite for OrderItem.course

   @@index([topicId])
 }

 model CourseTranslation {
   id               Int      @id @default(autoincrement())
   courseId         Int
   locale           String   @db.VarChar(10)
   title            String   @db.VarChar(255)
   shortDescription String?  @db.VarChar(500)
   description      String?  @db.Text
   objectives       Json?
   targetAudience   Json?
   benefits         Json?
   createdAt        DateTime @default(now())
   updatedAt        DateTime @updatedAt

   course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

@@ -333,91 +336,94 @@ model Product {
   sold             Int      @default(0)
   price            Int      @default(0)
   published        Boolean  @default(true)
   createdAt        DateTime @default(now())
   updatedAt        DateTime @updatedAt

   @@index([type])
   @@index([published])
   @@index([price])
 }

 model Lesson {
   id              Int              @id @default(autoincrement())
   courseId        Int
   title           String
   slug            String
   description     String?
   content         String?          @db.LongText
   videoUrl        String?
   order           Int              @default(0)
   published       Boolean          @default(false)
   createdAt       DateTime         @default(now())
   updatedAt       DateTime         @updatedAt
   course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
   progress        LessonProgress[]
+  videoProgress   LessonVideoProgress[]
   modules         LessonModule[]
   translations    LessonTranslation[]

   @@unique([courseId, slug])
   @@index([courseId, order])
 }

 model LessonModule {
   id              Int          @id @default(autoincrement())
   lessonId        Int
   title           String
   description     String?
   order           Int          @default(0)
   published       Boolean      @default(true)
   createdAt       DateTime     @default(now())
   updatedAt       DateTime     @updatedAt

   lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
   videos LessonVideo[]
+  videoProgress LessonVideoProgress[]
   translations LessonModuleTranslation[]

   @@index([lessonId, order])
 }

 model LessonVideo {
   id              Int          @id @default(autoincrement())
   moduleId        Int
   title           String
   description     String?
   sourceUrl       String
   hlsPlaylistKey  String?
   durationSec     Int          @default(0)
   order           Int          @default(0)
   published       Boolean      @default(true)
   createdAt       DateTime     @default(now())
   updatedAt       DateTime     @updatedAt

   mediaType       LessonMediaType @default(VIDEO)

   module LessonModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
   translations LessonVideoTranslation[]
+  progress LessonVideoProgress[]

   @@index([moduleId, order])
 }


 model CourseContentTranslation {
   id             Int      @id @default(autoincrement())
   courseId       Int
   locale         String   @db.VarChar(10)
   objectives     Json?
   targetAudience Json?
   benefits       Json?
   createdAt      DateTime @default(now())
   updatedAt      DateTime @updatedAt

   course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

   @@unique([courseId, locale])
   @@index([locale])
 }

 model LessonTranslation {
   id          Int      @id @default(autoincrement())
   lessonId    Int
   locale      String   @db.VarChar(10)
@@ -460,109 +466,154 @@ model LessonVideoTranslation {

   @@unique([videoId, locale])
   @@index([locale])
 }

 model Enrollment {
   id       Int @id @default(autoincrement())
   userId   Int
   courseId Int
   orderId  Int

   createdAt DateTime @default(now())

   status     EnrollmentStatus @default(ACTIVE)
   enrolledAt DateTime         @default(now())
   updatedAt  DateTime         @updatedAt
   user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
   course     Course           @relation(fields: [courseId], references: [id], onDelete: Restrict)
   order      Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)

   @@unique([userId, courseId])
   @@index([courseId])
   @@index([orderId])
 }

+
+
+model CourseAccess {
+  id         Int              @id @default(autoincrement())
+  userId     Int
+  courseId   Int
+  status     CourseAccessStatus @default(ACTIVE)
+  grantedAt  DateTime         @default(now())
+  createdAt  DateTime         @default(now())
+  updatedAt  DateTime         @updatedAt
+
+  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
+  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
+
+  @@unique([userId, courseId])
+  @@index([courseId])
+}
+
 model LessonProgress {
   id           Int      @id @default(autoincrement())
   userId       Int
   lessonId     Int
   completed    Boolean  @default(false)
   lastOpenedAt DateTime @default(now())

   // tiến độ
   status          ProgressStatus @default(IN_PROGRESS)
   percent         Int            @default(0) // 0..100
   lastPositionSec Int            @default(0)
   completedAt     DateTime?

   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt
   lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
   user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

   @@unique([userId, lessonId])
   @@index([lessonId])
 }

+model LessonVideoProgress {
+  id          Int      @id @default(autoincrement())
+  userId      Int
+  lessonId    Int
+  moduleId    Int
+  videoId     Int
+  watchedSec  Int      @default(0)
+  completed   Boolean  @default(false)
+  completedAt DateTime?
+  createdAt   DateTime @default(now())
+  updatedAt   DateTime @updatedAt
+
+  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
+  lesson Lesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)
+  module LessonModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
+  video  LessonVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)
+
+  @@unique([userId, videoId])
+  @@index([userId, lessonId])
+  @@index([userId, moduleId])
+}
+
 enum ProgressStatus {
   IN_PROGRESS
   COMPLETED
 }

 enum LessonMediaType {
   VIDEO
   IMAGE
 }

 enum SpecialistLevel {
   JUNIOR
   SENIOR
   EXPERT
   THERAPIST
 }

 enum AppointmentStatus {
   PENDING
   CONFIRMED
   DONE
   CANCELED
 }

 enum Role {
   ADMIN
   MANAGER
   STAFF
   USER
 }


 enum EnrollmentStatus {
   ACTIVE
   CANCELED
 }

+enum CourseAccessStatus {
+  ACTIVE
+  CANCELED
+}
+
 enum OrderStatus {
   PENDING
   PAID
   CANCELED
   EXPIRED
 }

 model Order {
   id          Int          @id @default(autoincrement())
   code        String       @unique @db.VarChar(32) // mã đơn
   userId      Int
   status      OrderStatus  @default(PENDING)
   enrollments Enrollment[]

   currency String @default("VND") @db.VarChar(3)
   subtotal Int    @default(0)
   discount Int    @default(0)
   total    Int    @default(0)

   paidAt     DateTime?
   canceledAt DateTime?

   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt

diff --git a/backend/ayanavitabackend/app/api/prisma/seed.ts b/backend/ayanavitabackend/app/api/prisma/seed.ts
index 73525bea1d14ad09ed4b89d1fef57cdc008ea8f6..21867ad17db0a1b96114b85106c058139908349e 100644
--- a/backend/ayanavitabackend/app/api/prisma/seed.ts
+++ b/backend/ayanavitabackend/app/api/prisma/seed.ts
@@ -579,38 +579,107 @@ async function main() {
         description: seed.description,
         price: seed.price,
         published: seed.published,
       },
     })

     for (const trans of seed.translations) {
       await prisma.courseTranslation.upsert({
         where: { courseId_locale: { courseId: course.id, locale: trans.locale } },
         update: {
           title: trans.title,
           shortDescription: trans.shortDescription,
           description: trans.description,
         },
         create: {
           courseId: course.id,
           locale: trans.locale,
           title: trans.title,
           shortDescription: trans.shortDescription,
           description: trans.description,
         },
       })
     }
   }

+
+
+  // Isolated scope để tránh lỗi redeclare khi merge/cherry-pick trùng block seed demo.
+  {
+    const demoUser = await prisma.user.findUnique({ where: { id: 13 }, select: { id: true } })
+    if (!demoUser) {
+      throw new Error('Không tìm thấy user có sẵn id=13 để cấp quyền khóa học mẫu')
+    }
+
+    const [fundamentalCourse] = await prisma.course.findMany({ where: { slug: 'co-ban-cham-soc-da' }, take: 1 })
+    if (fundamentalCourse) {
+      const lessonOne = await prisma.lesson.upsert({
+        where: { courseId_slug: { courseId: fundamentalCourse.id, slug: 'lam-sach-da' } },
+        update: { title: 'Bài 1: Làm sạch da đúng cách', published: true, order: 1 },
+        create: {
+          courseId: fundamentalCourse.id,
+          title: 'Bài 1: Làm sạch da đúng cách',
+          slug: 'lam-sach-da',
+          description: 'Quy trình làm sạch da sáng và tối',
+          order: 1,
+          published: true,
+        },
+      })
+
+      const lessonTwo = await prisma.lesson.upsert({
+        where: { courseId_slug: { courseId: fundamentalCourse.id, slug: 'duong-am-phuc-hoi' } },
+        update: { title: 'Bài 2: Dưỡng ẩm & phục hồi', published: true, order: 2 },
+        create: {
+          courseId: fundamentalCourse.id,
+          title: 'Bài 2: Dưỡng ẩm & phục hồi',
+          slug: 'duong-am-phuc-hoi',
+          description: 'Thực hành cấp ẩm theo loại da',
+          order: 2,
+          published: true,
+        },
+      })
+
+      await prisma.lessonVideo.deleteMany({ where: { module: { lessonId: { in: [lessonOne.id, lessonTwo.id] } } } })
+      await prisma.lessonModule.deleteMany({ where: { lessonId: { in: [lessonOne.id, lessonTwo.id] } } })
+
+      const moduleOne = await prisma.lessonModule.create({ data: { lessonId: lessonOne.id, title: 'Module 1: Chuẩn bị', order: 1, published: true } })
+      const moduleTwo = await prisma.lessonModule.create({ data: { lessonId: lessonOne.id, title: 'Module 2: Thực hành', order: 2, published: true } })
+
+      await prisma.lessonVideo.createMany({
+        data: [
+          { moduleId: moduleOne.id, title: 'Video 1', sourceUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4', durationSec: 180, order: 1, published: true },
+          { moduleId: moduleOne.id, title: 'Video 2', sourceUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4', durationSec: 240, order: 2, published: true },
+          { moduleId: moduleTwo.id, title: 'Video 3', sourceUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4', durationSec: 300, order: 1, published: true },
+        ],
+        skipDuplicates: true,
+      })
+
+      const moduleThree = await prisma.lessonModule.create({ data: { lessonId: lessonTwo.id, title: 'Module 3: Bài tập', order: 1, published: true } })
+      await prisma.lessonVideo.createMany({
+        data: [
+          { moduleId: moduleThree.id, title: 'Video 4', sourceUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4', durationSec: 360, order: 1, published: true },
+        ],
+        skipDuplicates: true,
+      })
+
+      await prisma.courseAccess.upsert({
+        where: { userId_courseId: { userId: demoUser.id, courseId: fundamentalCourse.id } },
+        update: { status: 'ACTIVE', grantedAt: new Date() },
+        create: { userId: demoUser.id, courseId: fundamentalCourse.id, status: 'ACTIVE' },
+      })
+    }
+  }
+
+
   const courses = await prisma.course.findMany({ orderBy: { id: 'asc' } })
   console.log('🌱 Seed OK')
   console.log({ userId: user.id, coursesCount: courses.length, branches: branches.length, services: services.length, specialists: specialists.length })
 }

 main()
   .catch((e) => {
     console.error(e)
     process.exit(1)
   })
   .finally(async () => {
     await prisma.$disconnect()
   })
diff --git a/backend/ayanavitabackend/app/api/src/enrollments/enrollments.controller.ts b/backend/ayanavitabackend/app/api/src/enrollments/enrollments.controller.ts
index aeab98f14ff14ac5a447a95216afe4419b46cb84..5e0172abcf59544ae0749a9e0e95252a151b50ac 100644
--- a/backend/ayanavitabackend/app/api/src/enrollments/enrollments.controller.ts
+++ b/backend/ayanavitabackend/app/api/src/enrollments/enrollments.controller.ts
@@ -1,48 +1,48 @@
 import { Controller, Get, Param, ParseIntPipe, Post, Query, UseGuards } from '@nestjs/common'
 import { AccessTokenGuard } from '../auth/guards/access-token.guard'
 import { CurrentUser, JwtUser } from '../auth/decorators/current-user.decorator'
 import { EnrollmentsService } from './enrollments.service'
-import { EnrollmentStatus } from '@prisma/client'
+import { CourseAccessStatus } from '@prisma/client'

 @UseGuards(AccessTokenGuard)
 @Controller()
 export class EnrollmentsController {
   constructor(private readonly enrollments: EnrollmentsService) {}

   /**
    * Danh sách khóa học đã mua + progress
    */
   @Get('me/courses')
   myCourses(@CurrentUser() user: JwtUser) {
     return this.enrollments.myCoursesWithProgress(user)
   }
   // route mới: GET /me/enrollments?status=ACTIVE|CANCELED|ALL
   @Get('me/enrollments')
   myEnrollments(
     @CurrentUser() user: JwtUser,
     @Query('status') status?: 'ACTIVE' | 'CANCELED' | 'ALL',
   ) {
     // default ACTIVE nếu không truyền
     const normalized = (status ?? 'ACTIVE').toUpperCase() as 'ACTIVE' | 'CANCELED' | 'ALL'

     if (!['ACTIVE', 'CANCELED', 'ALL'].includes(normalized)) {
       // tránh 400 quá phức tạp, trả về mặc định ACTIVE
-      return this.enrollments.myEnrollments(user.sub, EnrollmentStatus.ACTIVE)
+      return this.enrollments.myEnrollments(user.sub, CourseAccessStatus.ACTIVE)
     }

     if (normalized === 'ALL') return this.enrollments.myEnrollments(user.sub, 'ALL')
-    return this.enrollments.myEnrollments(user.sub, normalized as EnrollmentStatus)
+    return this.enrollments.myEnrollments(user.sub, normalized as CourseAccessStatus)
   }


   /**
    * Hủy enrollment (soft cancel)
    */
   @Post('courses/:id/cancel')
   cancel(
     @CurrentUser() user: JwtUser,
     @Param('id', ParseIntPipe) courseId: number,
   ) {
     return this.enrollments.cancel(user.sub, courseId)
   }
 }
diff --git a/backend/ayanavitabackend/app/api/src/enrollments/enrollments.service.ts b/backend/ayanavitabackend/app/api/src/enrollments/enrollments.service.ts
index dccfd90dcfdd20ac30ddea3b7749fdd7fd11875b..d8cf90995483dc766228bd6983604eb6f0694a31 100644
--- a/backend/ayanavitabackend/app/api/src/enrollments/enrollments.service.ts
+++ b/backend/ayanavitabackend/app/api/src/enrollments/enrollments.service.ts
@@ -1,219 +1,158 @@
 import { ForbiddenException, Injectable, NotFoundException } from '@nestjs/common'
-import { EnrollmentStatus, Prisma, Role } from '@prisma/client'
+import { CourseAccessStatus, Prisma, Role } from '@prisma/client'
 import { PrismaService } from '../prisma/prisma.service'

 type JwtUser = { sub: number; role: Role | string }

 @Injectable()
 export class EnrollmentsService {
   constructor(private readonly prisma: PrismaService) {}
-  // ... các hàm hiện có của bạn giữ nguyên
-
-  /**
-   * GET /me/enrollments?status=ACTIVE|CANCELED|ALL
-   * - Mặc định: ACTIVE
-   * - Trả kèm course + order để đối soát "đã trả (PAID) / đã cấp quyền (ACTIVE) / đã hủy (CANCELED)"
-   */
-    async myEnrollments(
-    userId: number,
-    status?: EnrollmentStatus | 'ALL',
-  ) {
-    const where: Prisma.EnrollmentWhereInput = {
+
+  async myEnrollments(userId: number, status?: CourseAccessStatus | 'ALL') {
+    const where: Prisma.CourseAccessWhereInput = {
       userId,
       ...(status && status !== 'ALL' ? { status } : {}),
     }

-    return this.prisma.enrollment.findMany({
+    return this.prisma.courseAccess.findMany({
       where,
       select: {
         id: true,
         userId: true,
         courseId: true,
-        orderId: true,
         status: true,
-        enrolledAt: true,
+        grantedAt: true,
         createdAt: true,
         updatedAt: true,
         course: {
           select: {
             id: true,
             title: true,
             slug: true,
             description: true,
             thumbnail: true,
             price: true,
             published: true,
             _count: { select: { lessons: true } },
           },
         },
-        order: {
-          select: {
-            id: true,
-            code: true,
-            status: true,  // PENDING/PAID/...
-            currency: true,
-            subtotal: true,
-            discount: true,
-            total: true,
-            paidAt: true,      // nếu bạn đã set trong mark-paid thì sẽ có
-            createdAt: true,
-            updatedAt: true,
-          },
-        },
       },
       orderBy: [{ updatedAt: 'desc' }, { id: 'desc' }],
     })
   }
-  /**
-   * Tạo enrollment ACTIVE cho user + course.
-   * LƯU Ý: Schema Enrollment của bạn bắt buộc orderId => enroll() phải nhận orderId.
-   */
-  async enroll(userId: number, courseId: number, orderId: number) {
-    const course = await this.prisma.course.findUnique({
-      where: { id: courseId },
-      select: { id: true },
-    })
+
+  async grantAccess(userId: number, courseId: number) {
+    const course = await this.prisma.course.findUnique({ where: { id: courseId }, select: { id: true } })
     if (!course) throw new NotFoundException('Course not found')

-    try {
-      return await this.prisma.enrollment.create({
-        data: {
-          user: { connect: { id: userId } },
-          course: { connect: { id: courseId } },
-          order: { connect: { id: orderId } }, // BẮT BUỘC theo schema
-          status: EnrollmentStatus.ACTIVE,
-        },
-        select: {
-          id: true,
-          userId: true,
-          courseId: true,
-          orderId: true,
-          status: true,
-          enrolledAt: true,
-          updatedAt: true,
-        },
-      })
-    } catch (e) {
-      if (e instanceof Prisma.PrismaClientKnownRequestError && e.code === 'P2002') {
-        throw new ForbiddenException('Already enrolled')
-      }
-      throw e
-    }
+    return this.prisma.courseAccess.upsert({
+      where: { userId_courseId: { userId, courseId } },
+      update: { status: CourseAccessStatus.ACTIVE, grantedAt: new Date() },
+      create: { userId, courseId, status: CourseAccessStatus.ACTIVE },
+      select: { id: true, userId: true, courseId: true, status: true, grantedAt: true, updatedAt: true },
+    })
   }

-  /**
-   * Danh sách khóa học user đã enroll (ACTIVE) + metadata
-   */
   myCourses(userId: number) {
-    return this.prisma.enrollment.findMany({
-      where: { userId, status: EnrollmentStatus.ACTIVE },
+    return this.prisma.courseAccess.findMany({
+      where: { userId, status: CourseAccessStatus.ACTIVE },
       select: {
-        id: true, // enrollmentId
+        id: true,
+        courseId: true,
         status: true,
-        enrolledAt: true,
-        orderId: true,
+        grantedAt: true,
         course: {
           select: {
             id: true,
             title: true,
             slug: true,
             description: true,
             thumbnail: true,
             price: true,
             published: true,
             createdAt: true,
             updatedAt: true,
             _count: { select: { lessons: true } },
           },
         },
       },
-      orderBy: { enrolledAt: 'desc' },
+      orderBy: { grantedAt: 'desc' },
     })
   }

-  /**
-   * Danh sách khóa học + progress % (completedLessons/totalLessons)
-   *
-   * Quy tắc:
-   * - USER: chỉ tính trên lessons published=true
-   * - ADMIN: tính trên tất cả lessons
-   */
   async myCoursesWithProgress(user: JwtUser) {
     const userId = user.sub
     const isAdmin = user.role === 'ADMIN'
-    const enrollments = await this.myCourses(userId)
+    const accesses = await this.myCourses(userId)

-    if (enrollments.length === 0) return []
+    if (accesses.length === 0) return []

     const completed = await this.prisma.lessonProgress.findMany({
       where: {
         userId,
         status: 'COMPLETED',
         ...(isAdmin ? {} : { lesson: { published: true } }),
       },
       select: {
         lesson: { select: { courseId: true } },
       },
     })

     const completedCountByCourse = new Map<number, number>()
     for (const x of completed) {
       const courseId = x.lesson.courseId
       completedCountByCourse.set(courseId, (completedCountByCourse.get(courseId) || 0) + 1)
     }

-    const courseIds = enrollments.map((e) => e.course.id)
+    const courseIds = accesses.map((e) => e.course.id)
     const totals = await this.prisma.lesson.groupBy({
       by: ['courseId'],
       where: {
         courseId: { in: courseIds },
         ...(isAdmin ? {} : { published: true }),
       },
       _count: { _all: true },
     })
     const totalByCourse = new Map<number, number>(totals.map((t) => [t.courseId, t._count._all]))

-    return enrollments.map((e) => {
+    return accesses.map((e) => {
       const totalLessons = totalByCourse.get(e.course.id) || 0
       const completedLessons = completedCountByCourse.get(e.course.id) || 0
       const percent = totalLessons === 0 ? 0 : Math.round((completedLessons / totalLessons) * 100)

       return {
-        enrollmentId: e.id,
-        enrolledAt: e.enrolledAt,
+        id: e.id,
+        courseId: e.courseId,
         status: e.status,
-        orderId: e.orderId,
+        grantedAt: e.grantedAt,
         course: e.course,
         progress: { totalLessons, completedLessons, percent },
       }
     })
   }

   async cancel(userId: number, courseId: number) {
-    const enrollment = await this.prisma.enrollment.findUnique({
+    const access = await this.prisma.courseAccess.findUnique({
       where: { userId_courseId: { userId, courseId } },
       select: { id: true, status: true },
     })
-    if (!enrollment) throw new NotFoundException('Enrollment not found')
+    if (!access) throw new NotFoundException('Course access not found')

-    return this.prisma.enrollment.update({
+    return this.prisma.courseAccess.update({
       where: { userId_courseId: { userId, courseId } },
-      data: { status: EnrollmentStatus.CANCELED },
+      data: { status: CourseAccessStatus.CANCELED },
       select: { id: true, status: true, updatedAt: true },
     })
   }

-  /**
-   * Gate: chỉ cho xem lesson nếu đã enroll (hoặc admin)
-   */
   async assertEnrolledOrAdmin(user: JwtUser, courseId: number) {
     if (user.role === 'ADMIN') return

-    const e = await this.prisma.enrollment.findUnique({
+    const e = await this.prisma.courseAccess.findUnique({
       where: { userId_courseId: { userId: user.sub, courseId } },
       select: { status: true },
     })

-    if (!e || e.status !== EnrollmentStatus.ACTIVE) throw new ForbiddenException('Not enrolled')
+    if (!e || e.status !== CourseAccessStatus.ACTIVE) throw new ForbiddenException('Not enrolled')
   }
 }
diff --git a/backend/ayanavitabackend/app/api/src/lessons/lessons.service.ts b/backend/ayanavitabackend/app/api/src/lessons/lessons.service.ts
index 9464f34fc83637a7c7c275664d40489d6ec8d8c1..da715420a2e12b31670b2775bdf05878164d4834 100644
--- a/backend/ayanavitabackend/app/api/src/lessons/lessons.service.ts
+++ b/backend/ayanavitabackend/app/api/src/lessons/lessons.service.ts
@@ -21,68 +21,94 @@ export class LessonsService {
   async findOne(user: JwtUser, id: number, lang?: string) {
     const locale = this.resolveLocale(lang)
     const lesson = await this.prisma.lesson.findUnique({
       where: { id },
       select: {
         id: true, courseId: true, title: true, slug: true, description: true, order: true, published: true, content: true, videoUrl: true, createdAt: true, updatedAt: true,
         translations: { select: { locale: true, title: true, description: true } },
         modules: { where: user.role === 'ADMIN' ? {} : { published: true }, orderBy: [{ order: 'asc' }, { id: 'asc' }], select: {
           id: true, title: true, description: true, order: true, published: true,
           translations: { select: { locale: true, title: true, description: true } },
           videos: { where: user.role === 'ADMIN' ? {} : { published: true }, orderBy: [{ order: 'asc' }, { id: 'asc' }], select: { id: true, title: true, description: true, sourceUrl: true, hlsPlaylistKey: true, mediaType: true, durationSec: true, order: true, published: true, translations: { select: { locale: true, title: true, description: true } } } },
         } },
       },
     })
     if (!lesson) throw new NotFoundException('Lesson not found')
     await this.enrollments.assertEnrolledOrAdmin(user, lesson.courseId)
     if (user.role !== 'ADMIN' && !lesson.published) throw new NotFoundException('Lesson not found')
     if (user.role !== 'ADMIN') {
       const prev = await this.prisma.lesson.findFirst({ where: { courseId: lesson.courseId, published: true, OR: [{ order: { lt: lesson.order ?? 0 } }, { order: lesson.order ?? 0, id: { lt: lesson.id } }] }, select: { id: true }, orderBy: [{ order: 'desc' }, { id: 'desc' }] })
       if (prev) {
         const prevProgress = await this.prisma.lessonProgress.findUnique({ where: { userId_lessonId: { userId: user.sub, lessonId: prev.id } }, select: { status: true } })
         if (!prevProgress || prevProgress.status !== ProgressStatus.COMPLETED) throw new ForbiddenException('Complete previous lesson first')
       }
     }

+    const videoProgressRows = await this.prisma.lessonVideoProgress.findMany({
+      where: { userId: user.sub, lessonId: lesson.id },
+      select: { videoId: true, watchedSec: true, completed: true },
+    })
+    const videoProgressMap = new Map(videoProgressRows.map((item) => [item.videoId, item]))
+
     return {
       ...lesson,
       localizedTitle: lesson.translations.find((item) => item.locale === locale)?.title || lesson.title,
       localizedDescription: lesson.translations.find((item) => item.locale === locale)?.description || lesson.description,
-      modules: lesson.modules.map((module) => ({
-        ...module,
-        localizedTitle: module.translations.find((item) => item.locale === locale)?.title || module.title,
-        localizedDescription: module.translations.find((item) => item.locale === locale)?.description || module.description,
-        videos: module.videos.map((video) => ({
-          ...video,
-          localizedTitle: video.translations.find((item) => item.locale === locale)?.title || video.title,
-          localizedDescription: video.translations.find((item) => item.locale === locale)?.description || video.description,
-          playbackUrl: this.media.buildSingleMediaUrl(video.sourceUrl || video.hlsPlaylistKey || ''),
-        })),
-      })),
+      modules: lesson.modules.map((module) => {
+        const normalizedVideos = module.videos.map((video) => {
+          const progress = videoProgressMap.get(video.id)
+          const duration = Math.max(0, video.durationSec || 0)
+          const watchedSec = Math.min(duration, Math.max(0, progress?.watchedSec || 0))
+          const completed = progress?.completed === true || (duration > 0 && watchedSec >= duration)
+          return {
+            ...video,
+            localizedTitle: video.translations.find((item) => item.locale === locale)?.title || video.title,
+            localizedDescription: video.translations.find((item) => item.locale === locale)?.description || video.description,
+            playbackUrl: this.media.buildSingleMediaUrl(video.sourceUrl || video.hlsPlaylistKey || ''),
+            progress: { watchedSec, durationSec: duration, completed },
+          }
+        })
+        const moduleDuration = normalizedVideos.reduce((sum, video) => sum + (video.progress.durationSec || 0), 0)
+        const moduleWatched = normalizedVideos.reduce((sum, video) => sum + (video.progress.watchedSec || 0), 0)
+        const modulePercent = moduleDuration <= 0 ? 0 : Math.round((moduleWatched / moduleDuration) * 100)
+        return {
+          ...module,
+          localizedTitle: module.translations.find((item) => item.locale === locale)?.title || module.title,
+          localizedDescription: module.translations.find((item) => item.locale === locale)?.description || module.description,
+          videos: normalizedVideos,
+          progress: {
+            completed: normalizedVideos.length > 0 && normalizedVideos.every((video) => video.progress.completed),
+            watchedSec: moduleWatched,
+            durationSec: moduleDuration,
+            percent: Math.min(100, modulePercent),
+          },
+        }
+      }),
     }
   }

+
   async create(courseId: number, dto: CreateLessonDto) {
     return this.prisma.$transaction(async (tx) => {
       const lesson = await tx.lesson.create({ data: { courseId, title: dto.title, slug: dto.slug, description: dto.description, content: dto.content, videoUrl: dto.videoUrl, order: dto.order, published: dto.published } as any })
       await this.upsertLessonTranslations(tx, lesson.id, dto)
       if (dto.modules?.length) {
         for (const m of dto.modules) {
           const mod = await tx.lessonModule.create({ data: { lessonId: lesson.id, title: m.title, description: m.description, order: m.order, published: m.published } as any })
           await this.upsertModuleTranslations(tx, mod.id, m)
           if (m.videos?.length) {
             for (const [idx, v] of m.videos.entries()) {
               if (!v.sourceUrl?.trim()) throw new BadRequestException('Video/Image sourceUrl is required')
               const video = await tx.lessonVideo.create({ data: { moduleId: mod.id, title: v.title, description: v.description, sourceUrl: v.sourceUrl, mediaType: v.mediaType === 'IMAGE' ? LessonMediaType.IMAGE : LessonMediaType.VIDEO, durationSec: v.durationSec ?? 0, order: v.order ?? idx, published: v.published ?? true } as any })
               await this.upsertVideoTranslations(tx, video.id, v)
             }
           }
         }
       }
       return lesson
     })
   }

   async uploadModuleMedia(lessonId: number, moduleId: string, type: 'video' | 'image', file: { buffer: Buffer; originalname?: string }, order?: number) {
     const lesson = await this.prisma.lesson.findUnique({ where: { id: lessonId }, select: { id: true } })
     if (!lesson) throw new NotFoundException('Lesson not found')

diff --git a/backend/ayanavitabackend/app/api/src/progress/dto/upsert-progress.dto.ts b/backend/ayanavitabackend/app/api/src/progress/dto/upsert-progress.dto.ts
index d16edb74e8166a0e499bdfbbffef92c15037e2e1..c3462e06e7e17a4594f8c1c1db7996615c27ff93 100644
--- a/backend/ayanavitabackend/app/api/src/progress/dto/upsert-progress.dto.ts
+++ b/backend/ayanavitabackend/app/api/src/progress/dto/upsert-progress.dto.ts
@@ -1,14 +1,23 @@
-import { IsInt, IsOptional, Max, Min } from 'class-validator'
+import { IsBoolean, IsInt, IsOptional, Max, Min } from 'class-validator'

 export class UpsertProgressDto {
   @IsOptional()
   @IsInt()
   @Min(0)
   lastPositionSec?: number

   @IsOptional()
   @IsInt()
   @Min(0)
   @Max(100)
   percent?: number
+
+  @IsOptional()
+  @IsInt()
+  @Min(0)
+  watchedSec?: number
+
+  @IsOptional()
+  @IsBoolean()
+  completed?: boolean
 }
diff --git a/backend/ayanavitabackend/app/api/src/progress/progress.controller.ts b/backend/ayanavitabackend/app/api/src/progress/progress.controller.ts
index 29239ec2458a9582952231ab8464a2ffce44b094..1388a42ff99a70959edfdd7088ed3d8cf5951be8 100644
--- a/backend/ayanavitabackend/app/api/src/progress/progress.controller.ts
+++ b/backend/ayanavitabackend/app/api/src/progress/progress.controller.ts
@@ -1,60 +1,70 @@
 import {
   Body,
   Controller,
   Get,
   Param,
   ParseIntPipe,
   Post,
   UseGuards,
 } from '@nestjs/common'
 import { AccessTokenGuard } from '../auth/guards/access-token.guard'
 import { CurrentUser } from '../auth/decorators/current-user.decorator'
 import { ProgressService } from './progress.service'
 import { UpsertProgressDto } from './dto/upsert-progress.dto'

 type JwtUser = { sub: number; role: string }

 @UseGuards(AccessTokenGuard)
 @Controller()
 export class ProgressController {
   constructor(private readonly progress: ProgressService) {}

-  // Update progress trong lúc học (idempotent)
-  // POST /lessons/:id/progress
-  // body: { lastPositionSec?: number, percent?: number }
   @Post('lessons/:id/progress')
   upsert(
     @CurrentUser() user: JwtUser,
     @Param('id', ParseIntPipe) id: number,
     @Body() dto: UpsertProgressDto,
   ) {
     return this.progress.upsertLessonProgress(user, id, dto)
   }

-  // Mark complete (shortcut)
-  // POST /lessons/:id/complete
+  @Post('lessons/:id/videos/:videoId/progress')
+  upsertVideoProgress(
+    @CurrentUser() user: JwtUser,
+    @Param('id', ParseIntPipe) lessonId: number,
+    @Param('videoId', ParseIntPipe) videoId: number,
+    @Body() dto: UpsertProgressDto,
+  ) {
+    return this.progress.upsertVideoProgress(user, lessonId, videoId, dto)
+  }
+
+  @Post('lessons/:id/modules/:moduleId/complete')
+  completeModule(
+    @CurrentUser() user: JwtUser,
+    @Param('id', ParseIntPipe) lessonId: number,
+    @Param('moduleId', ParseIntPipe) moduleId: number,
+  ) {
+    return this.progress.completeModule(user, lessonId, moduleId)
+  }
+
   @Post('lessons/:id/complete')
   complete(
     @CurrentUser() user: JwtUser,
     @Param('id', ParseIntPipe) id: number,
   ) {
     return this.progress.completeLesson(user, id)
   }

-  // Progress list của user (My learning)
-  // GET /me/progress
   @Get('me/progress')
   my(@CurrentUser() user: JwtUser) {
     return this.progress.myProgress(user.sub)
   }

-  // Course progress (để FE Continue đúng bài đang dở)
-  // GET /me/courses/:courseId/progress
   @Get('me/courses/:courseId/progress')
   courseProgress(
     @CurrentUser() user: JwtUser,
     @Param('courseId', ParseIntPipe) courseId: number,
   ) {
     return this.progress.getCourseProgress(user, courseId)
   }
 }
diff --git a/backend/ayanavitabackend/app/api/src/progress/progress.service.ts b/backend/ayanavitabackend/app/api/src/progress/progress.service.ts
index 52e4f452332b5870c278baa7066e317b245beb2f..050bcb98e4dff7cd0fcbf540ab01a2546f42a00c 100644
--- a/backend/ayanavitabackend/app/api/src/progress/progress.service.ts
+++ b/backend/ayanavitabackend/app/api/src/progress/progress.service.ts
@@ -13,202 +13,291 @@ export class ProgressService {
     private readonly enrollments: EnrollmentsService,
   ) {}

   private clampPercent(p?: number) {
     if (p === undefined) return undefined
     if (p < 0) return 0
     if (p > 100) return 100
     return p
   }

   private async getLessonOrThrow(lessonId: number) {
     const lesson = await this.prisma.lesson.findUnique({
       where: { id: lessonId },
       select: {
         id: true,
         courseId: true,
         published: true,
         order: true,
         course: { select: { published: true } },
       },
     })
     if (!lesson) throw new NotFoundException('Lesson not found')
     return lesson
   }

-  /**
-   * Sequential lock gate:
-   * - ADMIN bypass
-   * - USER: lesson i chỉ mở nếu lesson i-1 COMPLETED
-   * - USER: chỉ xét lesson published=true
-   */
   private async assertLessonUnlockedOrAdmin(user: JwtUser, lessonId: number, courseId: number) {
     if (user.role === 'ADMIN') return

     const orderedLessons = await this.prisma.lesson.findMany({
       where: { courseId, published: true },
       select: { id: true },
       orderBy: [{ order: 'asc' }, { id: 'asc' }],
     })

     const idx = orderedLessons.findIndex((l) => l.id === lessonId)
     if (idx === -1) throw new NotFoundException('Lesson not found')
-
-    // lesson đầu tiên luôn mở
     if (idx === 0) return

     const prevLessonId = orderedLessons[idx - 1].id
     const prevProgress = await this.prisma.lessonProgress.findUnique({
       where: { userId_lessonId: { userId: user.sub, lessonId: prevLessonId } },
       select: { status: true },
     })

     if (prevProgress?.status !== ProgressStatus.COMPLETED) {
       throw new ForbiddenException('Lesson locked')
     }
   }

-  // POST /lessons/:id/progress  { percent?, lastPositionSec? }
+  private async recalculateLessonProgress(userId: number, lessonId: number) {
+    const lessonVideos = await this.prisma.lessonVideo.findMany({
+      where: { module: { lessonId, published: true }, published: true, mediaType: 'VIDEO' },
+      select: { id: true, durationSec: true },
+    })
+    const totalDurationSec = lessonVideos.reduce((sum, item) => sum + Math.max(0, item.durationSec || 0), 0)
+
+    const videoProgress = await this.prisma.lessonVideoProgress.findMany({
+      where: { userId, lessonId },
+      select: { videoId: true, watchedSec: true, completed: true },
+    })
+
+    const progressMap = new Map(videoProgress.map((item) => [item.videoId, item]))
+    const watchedDurationSec = lessonVideos.reduce((sum, video) => {
+      const row = progressMap.get(video.id)
+      const capped = Math.min(video.durationSec || 0, Math.max(0, row?.watchedSec || 0))
+      return sum + capped
+    }, 0)
+
+    const percent = totalDurationSec <= 0 ? 0 : Math.min(100, Math.round((watchedDurationSec / totalDurationSec) * 100))
+    const isCompleted = totalDurationSec > 0 && percent >= 100
+
+    const lessonProgress = await this.prisma.lessonProgress.upsert({
+      where: { userId_lessonId: { userId, lessonId } },
+      create: {
+        userId,
+        lessonId,
+        status: isCompleted ? ProgressStatus.COMPLETED : ProgressStatus.IN_PROGRESS,
+        percent,
+        lastPositionSec: watchedDurationSec,
+        lastOpenedAt: new Date(),
+        completedAt: isCompleted ? new Date() : null,
+      },
+      update: {
+        status: isCompleted ? ProgressStatus.COMPLETED : ProgressStatus.IN_PROGRESS,
+        percent,
+        lastPositionSec: watchedDurationSec,
+        lastOpenedAt: new Date(),
+        completedAt: isCompleted ? new Date() : null,
+      },
+      select: {
+        lessonId: true,
+        status: true,
+        percent: true,
+        lastPositionSec: true,
+        lastOpenedAt: true,
+        completedAt: true,
+        updatedAt: true,
+      },
+    })
+
+    return { lessonProgress, watchedDurationSec, totalDurationSec, percent }
+  }
+
   async upsertLessonProgress(user: JwtUser, lessonId: number, dto: UpsertProgressDto) {
     const lesson = await this.getLessonOrThrow(lessonId)
-
-    // Gate enroll (ADMIN bypass)
     await this.enrollments.assertEnrolledOrAdmin(user, lesson.courseId)

-    // USER không truy cập course/lesson unpublished (ẩn 404)
     if (user.role !== 'ADMIN') {
       if (!lesson.course.published) throw new NotFoundException('Lesson not found')
       if (!lesson.published) throw new NotFoundException('Lesson not found')
     }

-    // Gate lock (ADMIN bypass)
     await this.assertLessonUnlockedOrAdmin(user, lessonId, lesson.courseId)

     const percent = this.clampPercent(dto.percent)
-    const lastPositionSec = dto.lastPositionSec
     const shouldComplete = percent !== undefined && percent >= 100

     return this.prisma.lessonProgress.upsert({
       where: { userId_lessonId: { userId: user.sub, lessonId } },
-
       create: {
         userId: user.sub,
         lessonId,
         status: shouldComplete ? ProgressStatus.COMPLETED : ProgressStatus.IN_PROGRESS,
         percent: percent ?? 0,
-        lastPositionSec: lastPositionSec ?? 0,
+        lastPositionSec: dto.lastPositionSec ?? 0,
         lastOpenedAt: new Date(),
         completedAt: shouldComplete ? new Date() : null,
       },
-
       update: {
         ...(percent !== undefined ? { percent } : {}),
-        ...(lastPositionSec !== undefined ? { lastPositionSec } : {}),
+        ...(dto.lastPositionSec !== undefined ? { lastPositionSec: dto.lastPositionSec } : {}),
         lastOpenedAt: new Date(),
         ...(shouldComplete
           ? { status: ProgressStatus.COMPLETED, completedAt: new Date() }
           : { status: ProgressStatus.IN_PROGRESS, completedAt: null }),
       },
-
       select: {
         lessonId: true,
         status: true,
         percent: true,
         lastPositionSec: true,
         lastOpenedAt: true,
         completedAt: true,
         updatedAt: true,
       },
     })
   }

-  // POST /lessons/:id/complete
+  async upsertVideoProgress(user: JwtUser, lessonId: number, videoId: number, dto: UpsertProgressDto) {
+    const lesson = await this.getLessonOrThrow(lessonId)
+    await this.enrollments.assertEnrolledOrAdmin(user, lesson.courseId)
+    if (user.role !== 'ADMIN') {
+      if (!lesson.course.published) throw new NotFoundException('Lesson not found')
+      if (!lesson.published) throw new NotFoundException('Lesson not found')
+    }
+    await this.assertLessonUnlockedOrAdmin(user, lessonId, lesson.courseId)
+
+    const video = await this.prisma.lessonVideo.findFirst({
+      where: { id: videoId, module: { lessonId }, mediaType: 'VIDEO' },
+      select: { id: true, durationSec: true, moduleId: true },
+    })
+    if (!video) throw new NotFoundException('Video not found')
+
+    const watchedSec = Math.min(video.durationSec || 0, Math.max(0, dto.watchedSec ?? 0))
+    const isCompleted = dto.completed === true || (video.durationSec > 0 && watchedSec >= video.durationSec)
+
+    await this.prisma.lessonVideoProgress.upsert({
+      where: { userId_videoId: { userId: user.sub, videoId } },
+      create: {
+        userId: user.sub,
+        lessonId,
+        moduleId: video.moduleId,
+        videoId,
+        watchedSec,
+        completed: isCompleted,
+        completedAt: isCompleted ? new Date() : null,
+      },
+      update: {
+        watchedSec,
+        completed: isCompleted,
+        completedAt: isCompleted ? new Date() : null,
+      },
+    })
+
+    return this.recalculateLessonProgress(user.sub, lessonId)
+  }
+
+  async completeModule(user: JwtUser, lessonId: number, moduleId: number) {
+    const lesson = await this.getLessonOrThrow(lessonId)
+    await this.enrollments.assertEnrolledOrAdmin(user, lesson.courseId)
+
+    const videos = await this.prisma.lessonVideo.findMany({
+      where: { moduleId, module: { lessonId }, mediaType: 'VIDEO', published: true },
+      select: { id: true, durationSec: true },
+    })
+    if (videos.length === 0) throw new NotFoundException('Module not found')
+
+    await Promise.all(videos.map((video) => this.prisma.lessonVideoProgress.upsert({
+      where: { userId_videoId: { userId: user.sub, videoId: video.id } },
+      create: {
+        userId: user.sub,
+        lessonId,
+        moduleId,
+        videoId: video.id,
+        watchedSec: video.durationSec,
+        completed: true,
+        completedAt: new Date(),
+      },
+      update: {
+        watchedSec: video.durationSec,
+        completed: true,
+        completedAt: new Date(),
+      },
+    })))
+
+    return this.recalculateLessonProgress(user.sub, lessonId)
+  }
+
   async completeLesson(user: JwtUser, lessonId: number) {
     return this.upsertLessonProgress(user, lessonId, { percent: 100 })
   }

-  // GET /me/progress
   myProgress(userId: number) {
     return this.prisma.lessonProgress.findMany({
       where: { userId },
       select: {
         lessonId: true,
         status: true,
         percent: true,
         lastPositionSec: true,
         lastOpenedAt: true,
         completedAt: true,
         updatedAt: true,
         lesson: { select: { id: true, courseId: true, title: true, order: true, published: true } },
       },
       orderBy: [{ lastOpenedAt: 'desc' }],
     })
   }

-  // GET /me/courses/:courseId/progress
-  // Return đúng shape cho frontend:
-  // {
-  //   courseId, totalLessons, completedLessons, percent,
-  //   items: [{lessonId, status, seconds?, updatedAt?}]
-  // }
   async getCourseProgress(user: JwtUser, courseId: number) {
     await this.enrollments.assertEnrolledOrAdmin(user, courseId)

     const lessons = await this.prisma.lesson.findMany({
       where: {
         courseId,
         ...(user.role === 'ADMIN' ? {} : { published: true }),
       },
       select: { id: true, order: true, published: true },
       orderBy: [{ order: 'asc' }, { id: 'asc' }],
     })

     const progress = await this.prisma.lessonProgress.findMany({
       where: {
         userId: user.sub,
         lesson: { courseId, ...(user.role === 'ADMIN' ? {} : { published: true }) },
       },
       select: {
         lessonId: true,
         status: true,
         lastPositionSec: true,
-        lastOpenedAt: true,
         updatedAt: true,
       },
-      orderBy: [{ lastOpenedAt: 'desc' }, { updatedAt: 'desc' }],
-      take: 2000,
     })

     const progMap = new Map(progress.map((p) => [p.lessonId, p]))
-
     const totalLessons = lessons.length
     const completedLessons = lessons.filter((l) => progMap.get(l.id)?.status === ProgressStatus.COMPLETED).length
     const percentCourse = totalLessons === 0 ? 0 : Math.round((completedLessons / totalLessons) * 100)

-    // items đúng kiểu LessonProgress[] cho FE Continue
     const items = lessons
       .map((l) => {
         const p = progMap.get(l.id)
         if (!p) return null
         return {
           lessonId: l.id,
-          status: p.status, // IN_PROGRESS | COMPLETED
+          status: p.status,
           seconds: p.lastPositionSec ?? undefined,
-          updatedAt: (p.updatedAt ?? p.lastOpenedAt)?.toISOString?.() ?? undefined,
+          updatedAt: p.updatedAt?.toISOString?.() ?? undefined,
         }
       })
-      .filter(Boolean) as Array<{
-      lessonId: number
-      status: ProgressStatus
-      seconds?: number
-      updatedAt?: string
-    }>
+      .filter(Boolean)

     return {
       courseId,
       totalLessons,
       completedLessons,
       percent: percentCourse,
       items,
     }
   }
 }
